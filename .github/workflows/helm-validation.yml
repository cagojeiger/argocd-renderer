name: Helm Chart Validation

on:
  pull_request:
    paths:
      - 'helm/**'
    branches:
      - main
      - dev-*

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-helm-chart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add ArgoCD Helm repository
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update

      - name: Helm Lint (Strict Mode)
        run: |
          echo "ğŸ” Running helm lint with strict mode..."
          helm lint --strict helm/
          echo "âœ… Lint passed"

      - name: Build Helm Dependencies
        run: |
          echo "ğŸ“¦ Building Helm dependencies..."
          cd helm
          helm dependency build
          echo "âœ… Dependencies built successfully"

      - name: Helm Template Validation
        run: |
          echo "ğŸ¨ Validating Helm templates render correctly..."
          helm template argocd-renderer helm/ \
            --namespace argocd-renderer \
            --debug \
            > /tmp/rendered-manifests.yaml

          echo "âœ… Templates rendered successfully"
          echo "ğŸ“Š Rendered $(grep -c '^---' /tmp/rendered-manifests.yaml) Kubernetes resources"

      - name: Check Rendered Manifests
        run: |
          echo "ğŸ” Checking for common issues..."

          if grep -i "image:" /tmp/rendered-manifests.yaml | grep -q ":latest"; then
            echo "âš ï¸  Warning: Found images using 'latest' tag"
          fi

          echo "âœ… Manifest checks completed"

      - name: Validation Summary
        if: always()
        run: |
          echo "ğŸ“‹ Validation Summary"
          echo "===================="
          echo "Checks performed:"
          echo "  âœ“ Helm lint (strict mode)"
          echo "  âœ“ Dependency resolution"
          echo "  âœ“ Template rendering"
          echo "  âœ“ Manifest validation"

          if [ "${{ job.status }}" != "success" ]; then
            echo "âŒ Some validation checks failed"
            exit 1
          fi
          echo "âœ… All validation checks passed!"
